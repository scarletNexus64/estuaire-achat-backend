{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ dashboard_title }}{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #f35453, #eb316f);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-number {
            font-size: 3rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .metric-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .recent-activity {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            margin-right: 15px;
            font-size: 1.5rem;
        }
        
        .growth-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>üìä Dashboard Achat - ESTUAIRE</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'admin:index' %}">üè† Accueil</a></li>
                        <li class="breadcrumb-item active">üìä Dashboard Achat</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="container-fluid">
            <!-- Metrics Cards -->
            <div class="dashboard-grid">
                <div class="metric-card">
                    <div class="metric-icon">üë•</div>
                    <div class="metric-number">{{ total_users }}</div>
                    <div class="metric-label">
                        Utilisateurs Total
                        <span class="growth-badge">+{{ user_growth }}%</span>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">üÜï</div>
                    <div class="metric-number">{{ new_users_month }}</div>
                    <div class="metric-label">Nouveaux ce mois</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">üîë</div>
                    <div class="metric-number">{{ active_tokens }}</div>
                    <div class="metric-label">Tokens Actifs</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon">üìç</div>
                    <div class="metric-number">{{ total_locations }}</div>
                    <div class="metric-label">
                        Localisations
                        <span class="growth-badge">+{{ location_growth }}%</span>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Gender Distribution Chart -->
                <div class="col-md-6">
                    <div class="chart-container">
                        <h3 style="color: black;">üìä R√©partition par Genre</h3>
                        <canvas id="genderChart" width="400" height="200"></canvas>
                    </div>
                </div>
                
                <!-- Top Cities Chart -->
                <div class="col-md-6">
                    <div class="chart-container">
                        <h3 style="color: black;">üèôÔ∏è Top Villes</h3>
                        <canvas id="cityChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Recent Users -->
                <div class="col-md-6">
                    <div class="recent-activity">
                        <h3 style="color: black;">üë§ Utilisateurs R√©cents</h3>
                        {% for user in recent_users %}
                            <div class="activity-item">
                                <div class="activity-icon">üë§</div>
                                <div style="color: black;">
                                    <strong>{{ user.prenom }} {{ user.nom }}</strong><br>
                                    <small>{{ user.identifier }} - {{ user.date_joined|timesince }} ago</small>
                                </div>
                            </div>
                        {% empty %}
                            <p style="color: black;">Aucun utilisateur r√©cent</p>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Recent Locations -->
                <div class="col-md-6">
                    <div class="recent-activity">
                        <h3 style="color: black;">üìç Localisations R√©centes</h3>
                        {% for location in recent_locations %}
                            <div class="activity-item">
                                <div class="activity-icon">üìç</div>
                                <div style="color: black;">
                                    <strong>{{ location.name }}</strong><br>
                                    <small>{{ location.user.prenom }} {{ location.user.nom }} - {{ location.created_at|timesince }} ago</small>
                                </div>
                            </div>
                        {% empty %}
                            <p style="color: black;">Aucune localisation r√©cente</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- System Info -->
            <div class="row">
                <div class="col-12">
                    <div class="recent-activity">
                        <h3 style="color: black;">‚ÑπÔ∏è Informations Syst√®me</h3>
                        <div class="row">
                            <div class="col-md-3" style="color: black;">
                                <strong>üïê Derni√®re MAJ:</strong><br>
                                {{ last_updated|date:"d/m/Y H:i" }}
                            </div>
                            <div class="col-md-3" style="color: black;">
                                <strong>üìà Croissance Utilisateurs:</strong><br>
                                +{{ user_growth }}% ce mois
                            </div>
                            <div class="col-md-3" style="color: black;">
                                <strong>üìç Localisations par d√©faut:</strong><br>
                                {{ default_locations }}/{{ total_locations }}
                            </div>
                            <div class="col-md-3" style="color: black;">
                                <strong>üéØ Taux d'engagement:</strong><br>
                                {{ active_tokens }}/{{ total_users }} actifs
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Gender Distribution Chart
    const genderCtx = document.getElementById('genderChart').getContext('2d');
    const genderData = {
        labels: [
            {% for stat in gender_stats %}
                '{% if stat.gender == "M" %}üë® Masculin{% elif stat.gender == "F" %}üë© F√©minin{% else %}üåê Autre{% endif %}',
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for stat in gender_stats %}
                    {{ stat.count }},
                {% endfor %}
            ],
            backgroundColor: ['#f35453', '#eb316f', '#17a2b8'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    };

    new Chart(genderCtx, {
        type: 'doughnut',
        data: genderData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Top Cities Chart
    const cityCtx = document.getElementById('cityChart').getContext('2d');
    const cityData = {
        labels: [
            {% for city in top_cities %}
                'üèôÔ∏è {{ city.name }}',
            {% endfor %}
        ],
        datasets: [{
            label: 'Nombre d\'utilisateurs',
            data: [
                {% for city in top_cities %}
                    {{ city.count }},
                {% endfor %}
            ],
            backgroundColor: 'rgba(243, 84, 83, 0.8)',
            borderColor: '#f35453',
            borderWidth: 2
        }]
    };

    new Chart(cityCtx, {
        type: 'bar',
        data: cityData,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
</script>
{% endblock %}